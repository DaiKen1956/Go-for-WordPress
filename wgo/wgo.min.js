/*! MIT license, more info: wgo.waltheri.net */ !function(a,b){"use strict";var c=document.getElementsByTagName("script"),d=c[c.length-1].src.split("?")[0],e=d.split("/").slice(0,-1).join("/")+"/",f={version:"2.01",B:1,W:-1,ERROR_REPORT:!0,DIR:e,lang:"en",i18n:{en:{}}};f.opera=-1!=navigator.userAgent.search(/(opera)(?:.*version)?[ \/]([\w.]+)/i),f.webkit=-1!=navigator.userAgent.search(/(webkit)[ \/]([\w.]+)/i),f.msie=-1!=navigator.userAgent.search(/(msie) ([\w.]+)/i),f.mozilla=-1!=navigator.userAgent.search(/(mozilla)(?:.*? rv:([\w.]+))?/i)&&!f.webkit&&!f.msie,f.t=function(a){var b=f.i18n[f.lang][a]||f.i18n.en[a];if(b){for(var c=1;c<arguments.length;c++)b=b.replace("$",arguments[c]);return b}return a},f.extendClass=function(a,b){return b.prototype=Object.create(a.prototype),b.prototype.constructor=b,b.prototype.super=a,b},f.abstractMethod=function(){throw Error("unimplemented abstract method")},f.clone=function(a){if(a&&"object"==typeof a){var b=a.constructor==Array?[]:{};for(var c in a)b[c]=a[c]==a?a:f.clone(a[c]);return b}return a},f.filterHTML=function(a){return a&&"string"==typeof a?a.replace("<","&lt;").replace(">","&gt;"):a};var k,g=function(a,c){var c=c||{};for(var d in c)this[d]=c[d];for(var d in f.Board.default)this[d]===b&&(this[d]=f.Board.default[d]);this.tx=this.section.left,this.ty=this.section.top,this.bx=this.size-1-this.section.right,this.by=this.size-1-this.section.bottom,this.init(),a.appendChild(this.element),this.width&&this.height?this.setDimensions(this.width,this.height):this.width?this.setWidth(this.width):this.height&&this.setHeight(this.height)},h={draw:function(a,b){var c=b.getX(a.x),d=b.getY(a.y),e=b.stoneRadius;this.beginPath(),this.fillStyle="rgba(32,32,32,0.5)",this.arc(c-.5,d-.5,Math.max(0,e-.5),0,2*Math.PI,!0),this.fill()}},i=function(a,b,c){return a.obj_arr[b][c][0].c==f.B?"rgba(255,255,255,0.8)":"rgba(0,0,0,0.8)"},j=function(a,b){var c;a[b].clear(),a[b].draw(a);for(var d=0;d<a.size;d++)for(var e=0;e<a.size;e++)for(var f in a.obj_arr[d][e])c=a.obj_arr[d][e][f].type?"string"==typeof a.obj_arr[d][e][f].type?g.drawHandlers[a.obj_arr[d][e][f].type]:a.obj_arr[d][e][f].type:a.stoneHandler,c[b]&&c[b].draw.call(a[b].context,a.obj_arr[d][e][f],a);for(var f in a.obj_list){var c=a.obj_list[f].handler;c[b]&&c[b].draw.call(a[b].context,a.obj_list[f].args,a)}},l=function(a,b,c,d,e,f,g,h){a.strokeStyle="rgba(64,64,64,0.2)",a.lineWidth=d/30*h,a.beginPath(),d-=Math.max(1,a.lineWidth);var m,n,b,o,p,i=b+d*Math.cos(e*Math.PI),j=c+d*Math.sin(e*Math.PI),k=b+d*Math.cos(f*Math.PI),l=c+d*Math.sin(f*Math.PI);k>i?(m=(l-j)/(k-i),n=Math.atan(m)):k==i?n=Math.PI/2:(m=(l-j)/(k-i),n=Math.atan(m)-Math.PI);var q=g*d;o=Math.sin(n)*q,p=Math.cos(n)*q;var r=i+o,s=j-p,t=k+o,u=l-p;a.moveTo(i,j),a.bezierCurveTo(r,s,t,u,k,l),a.stroke()},m=function(a){for(var b=a.angle,c=a.angle,d=0;d<a.lines.length;d++)b+=a.lines[d],c-=a.lines[d],l(a.ctx,a.x,a.y,a.radius,b,c,a.factor,a.thickness)};g.drawHandlers={NORMAL:{stone:{draw:function(a,b){var g,c=b.getX(a.x),d=b.getY(a.y),e=b.stoneRadius;a.c==f.W?(g=this.createRadialGradient(c-2*e/5,d-2*e/5,e/3,c-e/5,d-e/5,5*e/5),g.addColorStop(0,"#fff"),g.addColorStop(1,"#aaa")):(g=this.createRadialGradient(c-2*e/5,d-2*e/5,1,c-e/5,d-e/5,4*e/5),g.addColorStop(0,"#666"),g.addColorStop(1,"#000")),this.beginPath(),this.fillStyle=g,this.arc(c-.5,d-.5,Math.max(0,e-.5),0,2*Math.PI,!0),this.fill()}},shadow:h},PAINTED:{stone:{draw:function(a,b){var g,c=b.getX(a.x),d=b.getY(a.y),e=b.stoneRadius;a.c==f.W?(g=this.createRadialGradient(c-2*e/5,d-2*e/5,2,c-e/5,d-e/5,4*e/5),g.addColorStop(0,"#fff"),g.addColorStop(1,"#ddd")):(g=this.createRadialGradient(c-2*e/5,d-2*e/5,1,c-e/5,d-e/5,4*e/5),g.addColorStop(0,"#111"),g.addColorStop(1,"#000")),this.beginPath(),this.fillStyle=g,this.arc(c-.5,d-.5,Math.max(0,e-.5),0,2*Math.PI,!0),this.fill(),this.beginPath(),this.lineWidth=e/6,a.c==f.W?(this.strokeStyle="#999",this.arc(c+e/8,d+e/8,e/2,0,Math.PI/2,!1)):(this.strokeStyle="#ccc",this.arc(c-e/8,d-e/8,e/2,Math.PI,1.5*Math.PI)),this.stroke()}},shadow:h},GLOW:{stone:{draw:function(a,b){var g,c=b.getX(a.x),d=b.getY(a.y),e=b.stoneRadius;a.c==f.W?(g=this.createRadialGradient(c-2*e/5,d-2*e/5,e/3,c-e/5,d-e/5,8*e/5),g.addColorStop(0,"#fff"),g.addColorStop(1,"#666")):(g=this.createRadialGradient(c-2*e/5,d-2*e/5,1,c-e/5,d-e/5,3*e/5),g.addColorStop(0,"#555"),g.addColorStop(1,"#000")),this.beginPath(),this.fillStyle=g,this.arc(c-.5,d-.5,Math.max(0,e-.5),0,2*Math.PI,!0),this.fill()}},shadow:h},SHELL:{stone:{draw:function(a,b){var c,d,e=b.stoneRadius;k=k||Math.ceil(9999999*Math.random()),c=b.getX(a.x),d=b.getY(a.y);var g;if(g=a.c==f.W?"#aaa":"#000",this.beginPath(),this.fillStyle=g,this.arc(c-.5,d-.5,Math.max(0,e-.5),0,2*Math.PI,!0),this.fill(),a.c==f.W){var h=k%(3+a.x*b.size+a.y)%3,i=b.size*b.size+a.x*b.size+a.y,j=2/i*(k%i);0==h?m({ctx:this,x:c,y:d,radius:e,angle:j,lines:[.1,.12,.11,.1,.09,.09,.09,.09],factor:.25,thickness:1.75}):1==h?m({ctx:this,x:c,y:d,radius:e,angle:j,lines:[.1,.09,.08,.07,.06,.06,.06,.06,.06,.06,.06],factor:.2,thickness:1.5}):m({ctx:this,x:c,y:d,radius:e,angle:j,lines:[.12,.14,.13,.12,.12,.12],factor:.3,thickness:2}),g=this.createRadialGradient(c-2*e/5,d-2*e/5,e/3,c-e/5,d-e/5,5*e/5),g.addColorStop(0,"rgba(255,255,255,0.9)"),g.addColorStop(1,"rgba(255,255,255,0)"),this.beginPath(),this.fillStyle=g,this.arc(c-.5,d-.5,Math.max(0,e-.5),0,2*Math.PI,!0),this.fill()}else g=this.createRadialGradient(c+.4*e,d+.4*e,0,c+.5*e,d+.5*e,e),g.addColorStop(0,"rgba(32,32,32,1)"),g.addColorStop(1,"rgba(0,0,0,0)"),this.beginPath(),this.fillStyle=g,this.arc(c-.5,d-.5,Math.max(0,e-.5),0,2*Math.PI,!0),this.fill(),g=this.createRadialGradient(c-.4*e,d-.4*e,1,c-.5*e,d-.5*e,1.5*e),g.addColorStop(0,"rgba(64,64,64,1)"),g.addColorStop(1,"rgba(0,0,0,0)"),this.beginPath(),this.fillStyle=g,this.arc(c-.5,d-.5,Math.max(0,e-.5),0,2*Math.PI,!0),this.fill()}},shadow:h},MONO:{stone:{draw:function(a,b){var c=b.getX(a.x),d=b.getY(a.y),e=b.stoneRadius,g=b.lineWidth||1;this.fillStyle=a.c==f.W?"white":"black",this.beginPath(),this.arc(c,d,Math.max(0,e-g),0,2*Math.PI,!0),this.fill(),this.lineWidth=g,this.strokeStyle="black",this.stroke()}}},CR:{stone:{draw:function(a,b){var c=b.getX(a.x),d=b.getY(a.y),e=b.stoneRadius;this.strokeStyle=a.c||i(b,a.x,a.y),this.lineWidth=a.lineWidth||b.lineWidth||1,this.beginPath(),this.arc(c-.5,d-.5,e/2,0,2*Math.PI,!0),this.stroke()}}},LB:{stone:{draw:function(a,b){var c=b.getX(a.x),d=b.getY(a.y),e=b.stoneRadius,f=a.font||b.font||"";this.fillStyle=a.c||i(b,a.x,a.y),this.font=1==a.text.length?Math.round(1.5*e)+"px "+f:2==a.text.length?Math.round(1.2*e)+"px "+f:Math.round(e)+"px "+f,this.beginPath(),this.textBaseline="middle",this.textAlign="center",this.fillText(a.text,c,d,2*e)}},grid:{draw:function(a,b){if(!b.obj_arr[a.x][a.y][0].c&&!a._nodraw){var c=b.getX(a.x),d=b.getY(a.y),e=b.stoneRadius;this.clearRect(c-e,d-e,2*e,2*e)}},clear:function(a,b){b.obj_arr[a.x][a.y][0].c||(a._nodraw=!0,j(b,"grid"),delete a._nodraw)}}},SQ:{stone:{draw:function(a,b){var c=b.getX(a.x),d=b.getY(a.y),e=Math.round(b.stoneRadius);this.strokeStyle=a.c||i(b,a.x,a.y),this.lineWidth=a.lineWidth||b.lineWidth||1,this.beginPath(),this.rect(Math.round(c-e/2)-.5,Math.round(d-e/2)-.5,e,e),this.stroke()}}},TR:{stone:{draw:function(a,b){var c=b.getX(a.x),d=b.getY(a.y),e=b.stoneRadius;this.strokeStyle=a.c||i(b,a.x,a.y),this.lineWidth=a.lineWidth||b.lineWidth||1,this.beginPath(),this.moveTo(c-.5,d-.5-Math.round(e/2)),this.lineTo(Math.round(c-e/2)-.5,Math.round(d+e/3)+.5),this.lineTo(Math.round(c+e/2)+.5,Math.round(d+e/3)+.5),this.closePath(),this.stroke()}}},MA:{stone:{draw:function(a,b){var c=b.getX(a.x),d=b.getY(a.y),e=b.stoneRadius;this.strokeStyle=a.c||i(b,a.x,a.y),this.lineWidth=2*(a.lineWidth||b.lineWidth||1),this.beginPath(),this.moveTo(Math.round(c-e/2),Math.round(d-e/2)),this.lineTo(Math.round(c+e/2),Math.round(d+e/2)),this.moveTo(Math.round(c+e/2)-1,Math.round(d-e/2)),this.lineTo(Math.round(c-e/2)-1,Math.round(d+e/2)),this.stroke()}}},SL:{stone:{draw:function(a,b){var c=b.getX(a.x),d=b.getY(a.y),e=b.stoneRadius;this.fillStyle=a.c||i(b,a.x,a.y),this.beginPath(),this.rect(c-e/2,d-e/2,e,e),this.fill()}}},SM:{stone:{draw:function(a,b){var c=b.getX(a.x),d=b.getY(a.y),e=b.stoneRadius;this.strokeStyle=a.c||i(b,a.x,a.y),this.lineWidth=2*(a.lineWidth||b.lineWidth||1),this.beginPath(),this.arc(c-e/3,d-e/3,e/6,0,2*Math.PI,!0),this.stroke(),this.beginPath(),this.arc(c+e/3,d-e/3,e/6,0,2*Math.PI,!0),this.stroke(),this.beginPath(),this.moveTo(c-e/1.5,d),this.bezierCurveTo(c-e/1.5,d+e/2,c+e/1.5,d+e/2,c+e/1.5,d),this.stroke()}}},outline:{stone:{draw:function(a,b){this.globalAlpha=.3,a.stoneStyle?g.drawHandlers[a.stoneStyle].stone.draw.call(this,a,b):b.stoneHandler.stone.draw.call(this,a,b),this.globalAlpha=1}}},mini:{stone:{draw:function(a,b){b.stoneRadius=b.stoneRadius/2,a.stoneStyle?g.drawHandlers[a.stoneStyle].stone.draw.call(this,a,b):b.stoneHandler.stone.draw.call(this,a,b),b.stoneRadius=2*b.stoneRadius}}}},g.coordinates={grid:{draw:function(a,b){var c,d,e,f,g,h;this.fillStyle="rgba(0,0,0,0.7)",this.textBaseline="middle",this.textAlign="center",this.font=b.stoneRadius+"px "+(b.font||""),e=b.getX(-.75),f=b.getX(b.size-.25),g=b.getY(-.75),h=b.getY(b.size-.25);for(var i=0;i<b.size;i++)c=i+"A".charCodeAt(0),c>="I".charCodeAt(0)&&c++,d=b.getY(i),this.fillText(b.size-i,e,d),this.fillText(b.size-i,f,d),d=b.getX(i),this.fillText(String.fromCharCode(c),d,g),this.fillText(String.fromCharCode(c),d,h);this.fillStyle="black"}}},g.CanvasLayer=function(){this.element=document.createElement("canvas"),this.context=this.element.getContext("2d")},g.CanvasLayer.prototype={constructor:g.CanvasLayer,setDimensions:function(a,b){this.element.width=a,this.element.height=b},draw:function(){},clear:function(){this.context.clearRect(0,0,this.element.width,this.element.height)}},g.GridLayer=f.extendClass(g.CanvasLayer,function(){this.super.call(this)}),g.GridLayer.prototype.draw=function(a){var b;this.context.beginPath(),this.context.lineWidth=1,this.context.strokeStyle="rgba(0,0,0,"+Math.min(1,a.stoneRadius/15)+")";var c=Math.round(a.left),d=Math.round(a.top),e=Math.round(a.fieldWidth*(a.size-1)),f=Math.round(a.fieldHeight*(a.size-1));this.context.strokeRect(c-.5,d-.5,e,f);for(var g=1;g<a.size-1;g++)b=Math.round(a.getX(g))-.5,this.context.moveTo(b,d),this.context.lineTo(b,d+f),b=Math.round(a.getY(g))-.5,this.context.moveTo(c,b),this.context.lineTo(c+e,b);if(this.context.stroke(),this.context.fillStyle="#000",a.starPoints[a.size])for(var h in a.starPoints[a.size])this.context.beginPath(),this.context.arc(a.getX(a.starPoints[a.size][h].x)-.5,a.getY(a.starPoints[a.size][h].y)-.5,a.starSize*(a.width/300+1),0,2*Math.PI,!0),this.context.fill()},g.ShadowLayer=f.extendClass(g.CanvasLayer,function(a){this.super.call(this),this.shadowSize=a===b?1:a}),g.ShadowLayer.prototype.setDimensions=function(a,b){this.super.prototype.setDimensions.call(this,a,b),this.context.setTransform(1,0,0,1,Math.round(this.shadowSize*a/300),Math.round(this.shadowSize*b/300))};var n=function(a,b){var c=b.getX(a.x),d=b.getY(a.y),e=b.stoneRadius;this.clearRect(c-e-.5,d-e-.5,2*e,2*e),this.clearRect(c-e-.5,d-e-.5,2*e,2*e)},o=function(){return 3*this.width/(4*(this.bx+1-this.tx)+2)-this.fieldWidth*this.tx},p=function(){return 3*this.height/(4*(this.by+1-this.ty)+2)-this.fieldHeight*this.ty},q=function(){return 4*this.width/(4*(this.bx+1-this.tx)+2)},r=function(){return 4*this.height/(4*(this.by+1-this.ty)+2)},s=function(a,b){var c;for(var d in this.obj_arr[a][b]){c=this.obj_arr[a][b][d].type?"string"==typeof this.obj_arr[a][b][d].type?g.drawHandlers[this.obj_arr[a][b][d].type]:this.obj_arr[a][b][d].type:this.stoneHandler;for(var e in c)c[e].clear?c[e].clear.call(this[e].context,this.obj_arr[a][b][d],this):n.call(this[e].context,this.obj_arr[a][b][d],this)}},t=function(a,b){var c;for(var d in this.obj_arr[a][b]){c=this.obj_arr[a][b][d].type?"string"==typeof this.obj_arr[a][b][d].type?g.drawHandlers[this.obj_arr[a][b][d].type]:this.obj_arr[a][b][d].type:this.stoneHandler;for(var e in c)c[e].draw.call(this[e].context,this.obj_arr[a][b][d],this)}},u=function(a){for(var e,f,b=0,c=0,d=this.grid.element;d&&"BODY"!=d.tagName;)b+=d.offsetTop,c+=d.offsetLeft,d=d.offsetParent;return e=Math.round((a.pageX-c-this.left)/this.fieldWidth),f=Math.round((a.pageY-b-this.top)/this.fieldHeight),{x:e>=this.size?-1:e,y:f>=this.size?-1:f}},v=function(){this.element.style.width=this.width+"px",this.element.style.height=this.height+"px",this.stoneRadius=this.stoneSize*Math.min(this.fieldWidth,this.fieldHeight)/2;for(var a in this.layers)this.layers[a].setDimensions(this.width,this.height)};g.prototype={constructor:g,init:function(){this.obj_arr=[];for(var a=0;a<this.size;a++){this.obj_arr[a]=[];for(var b=0;b<this.size;b++)this.obj_arr[a][b]=[]}this.obj_list=[],this.layers=[],this.listeners=[],this.element=document.createElement("div"),this.element.className="wgo-board",this.background&&("#"==this.background[0]?this.element.style.backgroundColor=this.background:this.element.style.backgroundImage="url('"+this.background+"')"),this.grid=new g.GridLayer,this.shadow=new g.ShadowLayer(this.shadowSize),this.stone=new g.CanvasLayer,this.addLayer(this.grid,100),this.addLayer(this.shadow,200),this.addLayer(this.stone,300)},setWidth:function(a){this.width=a,this.fieldHeight=this.fieldWidth=q.call(this),this.left=o.call(this),this.height=(this.by-this.ty+1.5)*this.fieldHeight,this.top=p.call(this),v.call(this),this.redraw()},setHeight:function(a){this.height=a,this.fieldWidth=this.fieldHeight=r.call(this),this.top=p.call(this),this.width=(this.bx-this.tx+1.5)*this.fieldWidth,this.left=o.call(this),v.call(this),this.redraw()},setDimensions:function(a,b){this.width=a||this.width,this.height=b||this.height,this.fieldWidth=q.call(this),this.fieldHeight=r.call(this),this.left=o.call(this),this.top=p.call(this),v.call(this),this.redraw()},getSection:function(){return this.section},setSection:function(a,b,c,d){this.section="object"==typeof a?a:{top:a,right:b,bottom:c,left:d},this.tx=this.section.left,this.ty=this.section.top,this.bx=this.size-1-this.section.right,this.by=this.size-1-this.section.bottom,this.setDimensions()},setSize:function(a){var a=a||19;if(a!=this.size){this.size=a,this.obj_arr=[];for(var b=0;b<this.size;b++){this.obj_arr[b]=[];for(var c=0;c<this.size;c++)this.obj_arr[b][c]=[]}this.bx=this.size-1-this.section.right,this.by=this.size-1-this.section.bottom,this.setDimensions()}},redraw:function(){for(var a=0;a<this.layers.length;a++)this.layers[a].clear(this),this.layers[a].draw(this);for(var a=0;a<this.size;a++)for(var b=0;b<this.size;b++)t.call(this,a,b);for(var c in this.obj_list){var d=this.obj_list[c].handler;for(var e in d)d[e].draw.call(this[e].context,this.obj_list[c].args,this)}},getX:function(a){return this.left+a*this.fieldWidth},getY:function(a){return this.top+a*this.fieldHeight},addLayer:function(a,b){a.element.style.position="absolute",a.element.style.zIndex=b,a.setDimensions(this.width,this.height),this.element.appendChild(a.element),this.layers.push(a)},removeLayer:function(a){var b=this.layers.indexOf(a);b>=0&&(this.layers.splice(b,1),this.element.removeChild(a.element))},update:function(a){if(a.remove&&"all"==a.remove)this.removeAllObjects();else if(a.remove)for(var b in a.remove)this.removeObject(a.remove[b]);if(a.add)for(var b in a.add)this.addObject(a.add[b])},addObject:function(a){if(a.constructor!=Array){s.call(this,a.x,a.y);for(var b in this.obj_arr[a.x][a.y])if(this.obj_arr[a.x][a.y][b].type==a.type)return this.obj_arr[a.x][a.y][b]=a,t.call(this,a.x,a.y),void 0;a.type?this.obj_arr[a.x][a.y].push(a):this.obj_arr[a.x][a.y].unshift(a),t.call(this,a.x,a.y)}else for(var b in a)this.addObject(a[b])},removeObject:function(a){if(a.constructor!=Array){for(var d,e=0;e<this.obj_arr[a.x][a.y].length;e++)if(this.obj_arr[a.x][a.y][e].type==a.type){d=e;break}d!==b&&(s.call(this,a.x,a.y),this.obj_arr[a.x][a.y].splice(d,1),t.call(this,a.x,a.y))}else for(var c in a)this.removeObject(a[c])},removeObjectsAt:function(a,b){this.obj_arr[a][b].length&&(s.call(this,a,b),this.obj_arr[a][b]=[])},removeAllObjects:function(){this.obj_arr=[];for(var a=0;a<this.size;a++){this.obj_arr[a]=[];for(var b=0;b<this.size;b++)this.obj_arr[a][b]=[]}this.redraw()},addCustomObject:function(a,b){this.obj_list.push({handler:a,args:b}),this.redraw()},removeCustomObject:function(a,b){for(var c in this.obj_list)if(this.obj_list[c].handler==a&&this.obj_list[c].args==b)return delete this.obj_list[c],this.redraw(),!0;return!1},addEventListener:function(a,b){var c=this,d={type:a,callback:b,handleEvent:function(a){var d=u.call(c,a);b(d.x,d.y,a)}};this.element.addEventListener(a,d,!0),this.listeners.push(d)},removeEventListener:function(a,b){for(var c in this.listeners)if(this.listeners[c].type==a&&this.listeners[c].callback==b)return this.element.removeEventListener(this.listeners[c].type,this.listeners[c],!0),delete this.listeners[c],!0;return!1},getState:function(){return{objects:f.clone(this.obj_arr),custom:f.clone(this.obj_list)}},restoreState:function(a){this.obj_arr=a.objects||this.obj_arr,this.obj_list=a.custom||this.obj_list,this.redraw()}},g.default={size:19,width:0,height:0,font:"Calibri",lineWidth:2,starPoints:{19:[{x:3,y:3},{x:9,y:3},{x:15,y:3},{x:3,y:9},{x:9,y:9},{x:15,y:9},{x:3,y:15},{x:9,y:15},{x:15,y:15}],13:[{x:3,y:3},{x:9,y:3},{x:3,y:9},{x:9,y:9}],9:[{x:4,y:4}]},stoneHandler:g.drawHandlers.NORMAL,starSize:1,shadowSize:1,stoneSize:1,section:{top:0,right:0,bottom:0,left:0},background:f.DIR+"wood1.jpg"},f.Board=g;var w=function(a){this.size=a||19,this.schema=[];for(var b=0;b<this.size*this.size;b++)this.schema[b]=0};w.prototype={constructor:f.Position,get:function(a,c){return 0>a||0>c||a>=this.size||c>=this.size?b:this.schema[a*this.size+c]},set:function(a,b,c){return this.schema[a*this.size+b]=c,this},clear:function(){for(var a=0;a<this.size*this.size;a++)this.schema[a]=0;return this},clone:function(){var a=new w(this.size);return a.schema=this.schema.slice(0),a},compare:function(a){for(var b=[],c=[],d=0;d<this.size*this.size;d++)this.schema[d]&&!a.schema[d]?c.push({x:Math.floor(d/this.size),y:d%this.size}):this.schema[d]!=a.schema[d]&&b.push({x:Math.floor(d/this.size),y:d%this.size,c:a.schema[d]});return{add:b,remove:c}}},f.Position=w;var x=function(a,c){this.size=a||19,this.repeating=c===b?"KO":c,this.stack=[],this.stack[0]=new w(this.size),this.stack[0].capCount={black:0,white:0},this.turn=f.B,Object.defineProperty(this,"position",{get:function(){return this.stack[this.stack.length-1]},set:function(a){this[this.stack.length-1]=a}})},y=function(a,b,c,d,e){c>=0&&c<a.size&&d>=0&&d<a.size&&a.get(c,d)==e&&(a.set(c,d,0),b.push({x:c,y:d}),y(a,b,c,d-1,e),y(a,b,c,d+1,e),y(a,b,c-1,d,e),y(a,b,c+1,d,e))},z=function(a,b,c,d,e){return 0>c||c>=a.size||0>d||d>=a.size?!0:0==a.get(c,d)?!1:1==b.get(c,d)||a.get(c,d)==-e?!0:(b.set(c,d,!0),z(a,b,c,d-1,e)&&z(a,b,c,d+1,e)&&z(a,b,c-1,d,e)&&z(a,b,c+1,d,e))},A=function(a,b,c,d){var e=[];if(b>=0&&b<a.size&&c>=0&&c<a.size&&a.get(b,c)==d){var f=new w(a.size);z(a,f,b,c,d)&&y(a,e,b,c,d)}return e},B=function(a,b,c){var d,e;if("KO"==this.repeating&&this.stack.length-2>=0)e=this.stack.length-2;else{if("ALL"!=this.repeating)return!0;e=0}for(var f=this.stack.length-2;f>=e;f--)if(this.stack[f].get(b,c)==a.get(b,c)){d=!0;for(var g=0;g<this.size*this.size;g++)if(this.stack[f].schema[g]!=a.schema[g]){d=!1;break}if(d)return!1}return!0};x.prototype={constructor:x,getPosition:function(){return this.stack[this.stack.length-1]},play:function(a,b,c,d){if(!this.isOnBoard(a,b))return 1;if(0!=this.position.get(a,b))return 2;c||(c=this.turn);var e=this.position.clone();e.set(a,b,c);var g=A(e,a-1,b,-c).concat(A(e,a+1,b,-c),A(e,a,b-1,-c),A(e,a,b+1,-c));if(!g.length){var h=new w(this.size);if(z(e,h,a,b,c))return 3}return this.repeating&&!B.call(this,e,a,b)?4:d?!1:(e.color=c,e.capCount={black:this.position.capCount.black,white:this.position.capCount.white},c==f.B?e.capCount.black+=g.length:e.capCount.white+=g.length,this.pushPosition(e),this.turn=-c,g)},pass:function(a){this.turn=a?-a:-this.turn,this.pushPosition(),this.position.color=-this.position.color},isValid:function(a,b,c){return"number"!=typeof this.play(a,b,c,!0)},isOnBoard:function(a,b){return a>=0&&b>=0&&a<this.size&&b<this.size},addStone:function(a,b,c){return this.isOnBoard(a,b)&&0==this.position.get(a,b)?(this.position.set(a,b,c||0),!0):!1},removeStone:function(a,b){return this.isOnBoard(a,b)&&0!=this.position.get(a,b)?(this.position.set(a,b,0),!0):!1},setStone:function(a,b,c){return this.isOnBoard(a,b)?(this.position.set(a,b,c||0),!0):!1},getStone:function(a,b){return this.isOnBoard(a,b)?this.position.get(a,b):0},pushPosition:function(a){if(!a){var a=this.position.clone();a.capCount={black:this.position.capCount.black,white:this.position.capCount.white},a.color=this.position.color}return this.stack.push(a),a.color&&(this.turn=-a.color),this},popPosition:function(){var a=null;return this.stack.length>0&&(a=this.stack.pop(),this.turn=0==this.stack.length?f.B:this.position.color?-this.position.color:-this.turn),a},firstPosition:function(){return this.stack=[],this.stack[0]=new w(this.size),this.stack[0].capCount={black:0,white:0},this.turn=f.B,this},getCaptureCount:function(a){return a==f.B?this.position.capCount.black:this.position.capCount.white},validatePosition:function(){for(var a,b,c=0,d=0,e=[],g=this.position.clone(),h=0;h<this.size;h++)for(var i=0;i<this.size;i++)a=this.position.get(h,i),a&&(b=e.length,e=e.concat(A(g,h-1,i,-a),A(g,h+1,i,-a),A(g,h,i-1,-a),A(g,h,i+1,-a)),a==f.B?d+=e-b:c+=e-b);return this.position.capCount.black+=d,this.position.capCount.white+=c,this.position.schema=g.schema,e}},f.Game=x,a.WGo=f}(window);